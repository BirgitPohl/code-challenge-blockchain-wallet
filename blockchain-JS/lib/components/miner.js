"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.Miner = void 0;

var fs = require('fs');

var path = require('path');

var {
  Blockchain,
  Transaction
} = require('./blockchain');

var EC = require('elliptic').ec;

var ec = new EC('secp256k1');
/**
 * Minacoin Transaction Manager
 * @class Miner
 * @access public
 * @property {string} myWalletAddress
 * @property {ec.Keypair} myKey
 * @property {string} theirWalletAddress
 * @property {Blockchain} minaCoin
 * @method getCycles
 * @method sendTransaction
 * @method getLatestBlock
 * @method getTheirBalance
 * @method initTransactions
 */

class Miner {
  constructor() {
    var myKey = ec.keyFromPrivate('874721b0cfd73d79c76c50d5b2ee59f7d9fe9c5743bc45c015c713903b46b7c4');
    this.myWalletAddress = myKey.getPublic('hex');
    this.myKey = myKey;
    var key = ec.genKeyPair().getPublic().encode('hex'); // generates a random key:

    var theirKey = ec.keyFromPrivate(key);
    this.theirWalletAddress = theirKey.getPublic('hex');
    this.minaCoin = new Blockchain();
  }
  /**
   * @summary Gets cycles from files in JSON format
   */


  getCycles() {
    try {
      var folderName = '../data/';
      return fs.readdirSync(folderName).map(file => {
        return require(path.resolve(folderName, file))['cycle'];
      });
    } catch (err) {
      // TODO Here could be a logger
      console.log('Getting cycles failed ' + err);
      return null;
    }
  }
  /**
   * @summary Sends a transaction
   * @param payload contains a string of a cycle
   * @fires sendTransaction
   * @fires Transaction.signTransaction
   * @fires minaCoin.addTransaction
   * @return undefined
   */


  sendTransaction(payload) {
    if (payload === undefined || payload === '') {
      throw new Error('Payload is not defined');
    }

    var tx1 = new Transaction(this.myWalletAddress, this.theirWalletAddress, 10, payload);
    tx1.signTransaction(this.myKey);
    this.minaCoin.addTransaction(tx1);
  }
  /**
   * @summary Gets the latest Block
   * @return Block
   */


  getLatestBlock() {
    return this.minaCoin.getLatestBlock();
  }
  /**
   * @summary Gets user's balance
   * @return number
   */


  getMyBalance() {
    return this.minaCoin.getBalanceOfAddress(this.myWalletAddress);
  }
  /**
  * @summary Gets other user's balance
  * @return number
  */


  getTheirBalance() {
    return this.minaCoin.getBalanceOfAddress(this.theirWalletAddress);
  }
  /*  */


  getData() {
    return {
      theirBalance: this.getTheirBalance(),
      myBalance: this.getMyBalance(),
      latestBlock: this.getLatestBlock()
    };
  }
  /**
   * @summary Initiates transaction
   * @fires getCycles
   * @fires sendTransaction
   * @fires minaCoin.minePendingTransactions
   * @return undefined
   */


  initTransactions() {
    var cycles = this.getCycles();

    for (var index = 0; index < cycles.length; index++) {
      var cycle = cycles[index];
      this.sendTransaction(cycle);
    }

    console.log('Starting the miner');
    this.minaCoin.minePendingTransactions(this.myWalletAddress);
  }

} //module.exports.Miner = Miner;


exports.Miner = Miner;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NvdXJjZS9jb21wb25lbnRzL21pbmVyLmpzIl0sIm5hbWVzIjpbImZzIiwicmVxdWlyZSIsInBhdGgiLCJCbG9ja2NoYWluIiwiVHJhbnNhY3Rpb24iLCJFQyIsImVjIiwiTWluZXIiLCJjb25zdHJ1Y3RvciIsIm15S2V5Iiwia2V5RnJvbVByaXZhdGUiLCJteVdhbGxldEFkZHJlc3MiLCJnZXRQdWJsaWMiLCJrZXkiLCJnZW5LZXlQYWlyIiwiZW5jb2RlIiwidGhlaXJLZXkiLCJ0aGVpcldhbGxldEFkZHJlc3MiLCJtaW5hQ29pbiIsImdldEN5Y2xlcyIsImZvbGRlck5hbWUiLCJyZWFkZGlyU3luYyIsIm1hcCIsImZpbGUiLCJyZXNvbHZlIiwiZXJyIiwiY29uc29sZSIsImxvZyIsInNlbmRUcmFuc2FjdGlvbiIsInBheWxvYWQiLCJ1bmRlZmluZWQiLCJFcnJvciIsInR4MSIsInNpZ25UcmFuc2FjdGlvbiIsImFkZFRyYW5zYWN0aW9uIiwiZ2V0TGF0ZXN0QmxvY2siLCJnZXRNeUJhbGFuY2UiLCJnZXRCYWxhbmNlT2ZBZGRyZXNzIiwiZ2V0VGhlaXJCYWxhbmNlIiwiZ2V0RGF0YSIsInRoZWlyQmFsYW5jZSIsIm15QmFsYW5jZSIsImxhdGVzdEJsb2NrIiwiaW5pdFRyYW5zYWN0aW9ucyIsImN5Y2xlcyIsImluZGV4IiwibGVuZ3RoIiwiY3ljbGUiLCJtaW5lUGVuZGluZ1RyYW5zYWN0aW9ucyJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBLElBQU1BLEVBQUUsR0FBR0MsT0FBTyxDQUFDLElBQUQsQ0FBbEI7O0FBQ0EsSUFBTUMsSUFBSSxHQUFHRCxPQUFPLENBQUMsTUFBRCxDQUFwQjs7QUFDQSxJQUFNO0FBQUNFLEVBQUFBLFVBQUQ7QUFBYUMsRUFBQUE7QUFBYixJQUE0QkgsT0FBTyxDQUFDLGNBQUQsQ0FBekM7O0FBQ0EsSUFBTUksRUFBRSxHQUFHSixPQUFPLENBQUMsVUFBRCxDQUFQLENBQW9CSyxFQUEvQjs7QUFDQSxJQUFNQSxF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QUFLLEdBQUdILE1BQU0sQ0FBQ0MsS0FBRCxDQUFsQjtBQUNBLFdBQUtqQixlQUFMLENBQXFCbUIsS0FBckI7QUFDSDs7QUFFRHJCLElBQUFBLE9BQU8sQ0FBQ0MsR0FBUixDQUFZLG9CQUFaO0FBQ0EsU0FBS1QsUUFBTCxDQUFjOEIsdUJBQWQsQ0FBc0MsS0FBS3JDLGVBQTNDO0FBQ0g7O0FBakdjLEMsQ0FvR25CIiwic291cmNlc0NvbnRlbnQiOlsiY29uc3QgZnMgPSByZXF1aXJlKCdmcycpO1xuY29uc3QgcGF0aCA9IHJlcXVpcmUoJ3BhdGgnKTtcbmNvbnN0IHtCbG9ja2NoYWluLCBUcmFuc2FjdGlvbn0gPSByZXF1aXJlKCcuL2Jsb2NrY2hhaW4nKTtcbmNvbnN0IEVDID0gcmVxdWlyZSgnZWxsaXB0aWMnKS5lYztcbmNvbnN0IGVjID0gbmV3IEVDKCdzZWNwMjU2azEnKTtcblxuLyoqXG4gKiBNaW5hY29pbiBUcmFuc2FjdGlvbiBNYW5hZ2VyXG4gKiBAY2xhc3MgTWluZXJcbiAqIEBhY2Nlc3MgcHVibGljXG4gKiBAcHJvcGVydHkge3N0cmluZ30gbXlXYWxsZXRBZGRyZXNzXG4gKiBAcHJvcGVydHkge2VjLktleXBhaXJ9IG15S2V5XG4gKiBAcHJvcGVydHkge3N0cmluZ30gdGhlaXJXYWxsZXRBZGRyZXNzXG4gKiBAcHJvcGVydHkge0Jsb2NrY2hhaW59IG1pbmFDb2luXG4gKiBAbWV0aG9kIGdldEN5Y2xlc1xuICogQG1ldGhvZCBzZW5kVHJhbnNhY3Rpb25cbiAqIEBtZXRob2QgZ2V0TGF0ZXN0QmxvY2tcbiAqIEBtZXRob2QgZ2V0VGhlaXJCYWxhbmNlXG4gKiBAbWV0aG9kIGluaXRUcmFuc2FjdGlvbnNcbiAqL1xuZXhwb3J0IGNsYXNzIE1pbmVyIHtcbiAgICBjb25zdHJ1Y3RvcigpIHtcbiAgICAgICAgY29uc3QgbXlLZXkgPSBlYy5rZXlGcm9tUHJpdmF0ZSgnODc0NzIxYjBjZmQ3M2Q3OWM3NmM1MGQ1YjJlZTU5ZjdkOWZlOWM1NzQzYmM0NWMwMTVjNzEzOTAzYjQ2YjdjNCcpO1xuICAgICAgICB0aGlzLm15V2FsbGV0QWRkcmVzcyA9IG15S2V5LmdldFB1YmxpYygnaGV4Jyk7XG4gICAgICAgIHRoaXMubXlLZXkgPSBteUtleTtcbiAgICAgICAgY29uc3Qga2V5ID0gZWMuZ2VuS2V5UGFpcigpLmdldFB1YmxpYygpLmVuY29kZSgnaGV4Jyk7IC8vIGdlbmVyYXRlcyBhIHJhbmRvbSBrZXk6XG4gICAgICAgIGNvbnN0IHRoZWlyS2V5ID0gZWMua2V5RnJvbVByaXZhdGUoa2V5KTtcbiAgICAgICAgdGhpcy50aGVpcldhbGxldEFkZHJlc3MgPSB0aGVpcktleS5nZXRQdWJsaWMoJ2hleCcpO1xuICAgICAgICB0aGlzLm1pbmFDb2luID0gbmV3IEJsb2NrY2hhaW4oKTsgXG4gICAgfVxuXG4vKipcbiAqIEBzdW1tYXJ5IEdldHMgY3ljbGVzIGZyb20gZmlsZXMgaW4gSlNPTiBmb3JtYXRcbiAqL1xuICAgIGdldEN5Y2xlcygpIHtcbiAgICAgICAgdHJ5IHtcbiAgICAgICAgICAgIGNvbnN0IGZvbGRlck5hbWUgPSAnLi4vZGF0YS8nO1xuXG4gICAgICAgICAgICByZXR1cm4gZnMucmVhZGRpclN5bmMoZm9sZGVyTmFtZSkubWFwKGZpbGUgPT4ge1xuICAgICAgICAgICAgICAgIHJldHVybiByZXF1aXJlKHBhdGgucmVzb2x2ZShmb2xkZXJOYW1lLCBmaWxlKSlbJ2N5Y2xlJ107XG4gICAgICAgICAgICB9KTtcbiAgICAgICAgfVxuICAgICAgICBjYXRjaCAoZXJyKSB7XG4gICAgICAgICAgICAvLyBUT0RPIEhlcmUgY291bGQgYmUgYSBsb2dnZXJcbiAgICAgICAgICAgIGNvbnNvbGUubG9nKCdHZXR0aW5nIGN5Y2xlcyBmYWlsZWQgJyArIGVycik7XG5cbiAgICAgICAgICAgIHJldHVybiBudWxsO1xuICAgICAgICB9XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHN1bW1hcnkgU2VuZHMgYSB0cmFuc2FjdGlvblxuICAgICAqIEBwYXJhbSBwYXlsb2FkIGNvbnRhaW5zIGEgc3RyaW5nIG9mIGEgY3ljbGVcbiAgICAgKiBAZmlyZXMgc2VuZFRyYW5zYWN0aW9uXG4gICAgICogQGZpcmVzIFRyYW5zYWN0aW9uLnNpZ25UcmFuc2FjdGlvblxuICAgICAqIEBmaXJlcyBtaW5hQ29pbi5hZGRUcmFuc2FjdGlvblxuICAgICAqIEByZXR1cm4gdW5kZWZpbmVkXG4gICAgICovXG4gICAgc2VuZFRyYW5zYWN0aW9uIChwYXlsb2FkKSB7XG4gICAgICAgIGlmKHBheWxvYWQgPT09IHVuZGVmaW5lZCB8fCBwYXlsb2FkID09PSAnJykge1xuICAgICAgICAgICAgdGhyb3cgbmV3IEVycm9yKCdQYXlsb2FkIGlzIG5vdCBkZWZpbmVkJyk7XG4gICAgICAgIH1cbiAgICAgICAgY29uc3QgdHgxID0gbmV3IFRyYW5zYWN0aW9uKHRoaXMubXlXYWxsZXRBZGRyZXNzLCB0aGlzLnRoZWlyV2FsbGV0QWRkcmVzcywgMTAsIHBheWxvYWQpO1xuICAgICAgICB0eDEuc2lnblRyYW5zYWN0aW9uKHRoaXMubXlLZXkpO1xuICAgICAgICB0aGlzLm1pbmFDb2luLmFkZFRyYW5zYWN0aW9uKHR4MSk7XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHN1bW1hcnkgR2V0cyB0aGUgbGF0ZXN0IEJsb2NrXG4gICAgICogQHJldHVybiBCbG9ja1xuICAgICAqL1xuICAgIGdldExhdGVzdEJsb2NrICgpIHtcbiAgICAgICAgcmV0dXJuIHRoaXMubWluYUNvaW4uZ2V0TGF0ZXN0QmxvY2soKTtcbiAgICB9XG5cbiAgICAvKipcbiAgICAgKiBAc3VtbWFyeSBHZXRzIHVzZXIncyBiYWxhbmNlXG4gICAgICogQHJldHVybiBudW1iZXJcbiAgICAgKi9cbiAgICBnZXRNeUJhbGFuY2UgKCkge1xuICAgICAgICByZXR1cm4gdGhpcy5taW5hQ29pbi5nZXRCYWxhbmNlT2ZBZGRyZXNzKHRoaXMubXlXYWxsZXRBZGRyZXNzKTtcbiAgICB9XG4gICAgXG4gICAgIC8qKlxuICAgICAqIEBzdW1tYXJ5IEdldHMgb3RoZXIgdXNlcidzIGJhbGFuY2VcbiAgICAgKiBAcmV0dXJuIG51bWJlclxuICAgICAqL1xuICAgIGdldFRoZWlyQmFsYW5jZSAoKSB7XG4gICAgICAgIHJldHVybiB0aGlzLm1pbmFDb2luLmdldEJhbGFuY2VPZkFkZHJlc3ModGhpcy50aGVpcldhbGxldEFkZHJlc3MpO1xuICAgIH1cblxuICAgIC8qICAqL1xuICAgIGdldERhdGEoKSB7XG4gICAgICAgIHJldHVybiB7XG4gICAgICAgICAgICB0aGVpckJhbGFuY2U6IHRoaXMuZ2V0VGhlaXJCYWxhbmNlKCksXG4gICAgICAgICAgICBteUJhbGFuY2U6IHRoaXMuZ2V0TXlCYWxhbmNlKCksXG4gICAgICAgICAgICBsYXRlc3RCbG9jazogdGhpcy5nZXRMYXRlc3RCbG9jaygpXG4gICAgICAgIH07XG4gICAgfVxuXG4gICAgLyoqXG4gICAgICogQHN1bW1hcnkgSW5pdGlhdGVzIHRyYW5zYWN0aW9uXG4gICAgICogQGZpcmVzIGdldEN5Y2xlc1xuICAgICAqIEBmaXJlcyBzZW5kVHJhbnNhY3Rpb25cbiAgICAgKiBAZmlyZXMgbWluYUNvaW4ubWluZVBlbmRpbmdUcmFuc2FjdGlvbnNcbiAgICAgKiBAcmV0dXJuIHVuZGVmaW5lZFxuICAgICAqL1xuICAgIGluaXRUcmFuc2FjdGlvbnMoKSB7XG4gICAgICAgIGNvbnN0IGN5Y2xlcyA9IHRoaXMuZ2V0Q3ljbGVzKCk7XG5cbiAgICAgICAgZm9yIChsZXQgaW5kZXggPSAwOyBpbmRleCA8IGN5Y2xlcy5sZW5ndGg7IGluZGV4KyspIHtcbiAgICAgICAgICAgIGxldCBjeWNsZSA9IGN5Y2xlc1tpbmRleF07XG4gICAgICAgICAgICB0aGlzLnNlbmRUcmFuc2FjdGlvbihjeWNsZSk7XG4gICAgICAgIH1cblxuICAgICAgICBjb25zb2xlLmxvZygnU3RhcnRpbmcgdGhlIG1pbmVyJyk7XG4gICAgICAgIHRoaXMubWluYUNvaW4ubWluZVBlbmRpbmdUcmFuc2FjdGlvbnModGhpcy5teVdhbGxldEFkZHJlc3MpO1xuICAgIH1cbn1cblxuLy9tb2R1bGUuZXhwb3J0cy5NaW5lciA9IE1pbmVyO1xuXG4iXX0=